
<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Grammar Run</title>
<link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@600&display=swap" rel="stylesheet">
<style>
  body { margin:0; overflow:hidden; background:#a2d2ff; font-family: 'Work Sans', sans-serif; touch-action: none; }

  /* ‚îÄ‚îÄ PORTRAIT WARNING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  #portrait-warning {
    display: none;
    position: fixed; inset: 0; z-index: 999;
    background: #1a1a2e;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 30px;
    color: white;
  }
  #portrait-warning .phone-icon {
    font-size: 80px;
    animation: rotate-phone 1.5s ease-in-out infinite alternate;
    display: block; margin-bottom: 24px;
  }
  @keyframes rotate-phone {
    from { transform: rotate(0deg); }
    to   { transform: rotate(90deg); }
  }
  #portrait-warning h2 {
    font-size: 26px; margin: 0 0 12px;
    font-family: 'Work Sans', sans-serif;
  }
  #portrait-warning p {
    font-size: 16px; color: #aac; margin: 0;
    font-family: 'Work Sans', sans-serif;
  }
  @media (orientation: portrait) {
    #portrait-warning { display: flex; }
  }
  #ui {
    position:fixed; top:20px; left:20px; color: #222;
    background: rgba(255,255,255,0.95); padding: 18px 22px; border-radius: 14px; pointer-events: none;
    box-shadow: 0 6px 20px rgba(0,0,0,0.15); border-left: 7px solid #007bff; min-width: 180px;
  }
  .stat-label { font-size: 14px; color: #555; text-transform: uppercase; letter-spacing: 1.5px; }
  .stat-value { font-size: 32px; font-weight: bold; color: #007bff; margin-bottom: 8px; }
  
  #jump-budget {
    background: #fff3cd; padding: 5px 10px; border-radius: 5px; border: 1px solid #ffeeba;
    display: flex; align-items: center; gap: 5px; margin-top: 5px;
  }
  .star-icon { color: #f1c40f; font-size: 20px; }

  /* Coin jump indicator at top */
  #coin-indicator {
    position: fixed; top: 0; left: 50%; transform: translateX(-50%);
    background: rgba(255,255,255,0.97); padding: 10px 30px 10px 20px;
    border-radius: 0 0 20px 20px; box-shadow: 0 6px 20px rgba(0,0,0,0.18);
    display: flex; align-items: center; gap: 14px; pointer-events: none; z-index: 5;
    font-family: 'Work Sans', sans-serif;
  }
  #coin-indicator .ci-label { font-size: 16px; font-weight: bold; color: #555; }
  #coin-bar-wrap { background: #ffe082; border-radius: 10px; width: 240px; height: 26px; overflow: hidden; border: 3px solid #f1c40f; }
  #coin-bar { height: 100%; background: linear-gradient(90deg, #f1c40f, #ff9800); border-radius: 10px; transition: width 0.2s; }
  #coin-count-label { font-size: 18px; font-weight: bold; color: #b8860b; min-width: 80px; text-align: left; }

  #overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: #dadde2; display: flex; align-items: center; justify-content: center;
    color: #333; cursor: pointer; z-index: 10; flex-direction: column; text-align: center;
  }
  .desktop-hint { display: inline; }
  .mobile-hint  { display: none; }
  @media (pointer: coarse) {
    .desktop-hint { display: none; }
    .mobile-hint  { display: inline; }
    #start-hint-keyboard { display: none; }
    #start-hint-touch    { display: block !important; }

    /* Hide the keyboard how-to image on mobile */
    .how-to-img { display: none; }

    /* Smaller score counter */
    #ui {
      padding: 8px 12px;
      border-left-width: 4px;
      min-width: 0;
      border-radius: 10px;
    }
    .stat-label { font-size: 10px; letter-spacing: 1px; }
    .stat-value { font-size: 20px; margin-bottom: 4px; }

    /* Smaller coin bar */
    #coin-indicator {
      padding: 5px 14px 5px 10px;
      gap: 8px;
      border-radius: 0 0 12px 12px;
    }
    #coin-indicator .ci-label { font-size: 12px; }
    #coin-bar-wrap { width: 130px; height: 16px; border-width: 2px; }
    #coin-count-label { font-size: 12px; min-width: 50px; }

    /* Smaller health bar */
    #health-indicator {
      top: 36px !important;
      padding: 5px 12px !important;
      gap: 7px !important;
      border-radius: 10px !important;
    }
    #health-indicator span:first-child { font-size: 12px !important; }
    #health-indicator > div { width: 130px !important; height: 14px !important; border-width: 2px !important; }
    #health-val { font-size: 12px !important; min-width: 44px !important; }
  }
  #victory-modal {
    display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
    background: white; padding: 40px; border-radius: 20px; box-shadow: 0 0 50px rgba(0,0,0,0.3);
    z-index: 100; text-align: center; border: 5px solid #2ed573;
  }
  .btn { background: #007bff; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 18px; margin-top: 15px; font-family: 'Work Sans', sans-serif; font-weight: bold; }
</style>
</head>
<body>

<!-- ‚îÄ‚îÄ PORTRAIT WARNING ‚îÄ‚îÄ shown via CSS when phone is upright -->
<div id="portrait-warning">
  <span class="phone-icon">üì±</span>
  <h2>Please rotate your device</h2>
  <p>Grammar Run is best played in <strong>landscape mode</strong>.<br>Turn your phone on its side to begin!</p>
</div>

<audio id="bg-music" loop src="tune.mp3"></audio>
<audio id="rabbit-hurt" src="rabbit-hurt.mp3"></audio>
<audio id="jump-sound" src="jump.mp3"></audio>
<audio id="error-sound" src="error.mp3"></audio>
<audio id="jump-available" src="https://learnswedish.github.io/html/jump-available.mp3"></audio>

<div id="victory-modal">
  <h1 id="modal-title">SESSION ENDED</h1>
  <p id="final-stats" style="font-size: 20px;"></p>
  <button class="btn" onclick="location.reload()">PLAY AGAIN</button>
</div>

<div id="overlay">
  <img src="grammar-run.png" class="title-img" alt="How to play" height="20%">
  
  <p style="font-size: 18px; max-width: 700px; margin: 10px 0;">
    ‚≠ê Earn health by choosing the correct Swedish article (EN/ETT) ‚≠ê<br>
    <span class="desktop-hint">Use ‚Üê ‚Üí arrow keys to switch lanes &nbsp;|&nbsp; SPACEBAR to jump</span>
    <span class="mobile-hint">Swipe left/right to switch lanes &nbsp;|&nbsp; Swipe up to jump</span><br>
    Collect <strong>10 coins ü™ô</strong> before you can jump! &nbsp;|&nbsp; Mind the bunnies! üêá
  </p>
  
  <h2 id="high-score-display" style="color: #8b0000; margin: 10px 0;">RECORD: 0</h2>
  
  <h2 id="start-hint-keyboard" style="color: #007bff; margin: 10px 0;">Press ENTER to begin</h2>
  <h2 id="start-hint-touch" style="color: #007bff; margin: 10px 0; display: none;">Tap anywhere to begin</h2>

  <img id="start-img" src="start-1.png" class="center-img" alt="Start bild" height="35%">

  <img src="how-to.png" class="how-to-img" alt="How to play" height="20%">
</div>

<!-- Coin jump indicator top center -->
<div id="coin-indicator">
  <span class="ci-label">ü™ô Jump coins:</span>
  <div id="coin-bar-wrap"><div id="coin-bar" style="width:0%"></div></div>
  <span id="coin-count-label">0 / 10</span>
</div>

<div id="health-indicator" style="position: fixed; top: 58px; left: 50%; transform: translateX(-50%); display: flex; align-items: center; gap: 12px; z-index: 5; background: rgba(255,255,255,0.97); padding: 8px 20px; border-radius: 14px; box-shadow: 0 4px 14px rgba(0,0,0,0.13);">
  <span style="font-size: 16px; font-weight: bold; color: #555;">‚ù§Ô∏è Health:</span>
  <div style="background: #ffcdd2; border-radius: 10px; width: 240px; height: 22px; overflow: hidden; border: 3px solid #f44336;">
    <div id="health-bar" style="height: 100%; background: #f44336; width: 10%; transition: width 0.3s;"></div>
  </div>
  <span id="health-val" style="font-size: 17px; font-weight: bold; color: #d32f2f; min-width: 70px;">10 / 100</span>
</div>

<div id="ui">
  <div class="stat-label">Distance</div>
  <div id="score-val" class="stat-value">0 m</div>
</div>

<script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.158.0/build/three.module.js",
    "three/addons/": "https://unpkg.com/three@0.158.0/examples/jsm/"
  }
}
</script>

<script type="module">
import * as THREE from 'three';
import { FontLoader } from 'three/addons/loaders/FontLoader.js';
import { TextGeometry } from 'three/addons/geometries/TextGeometry.js';

// --- DATA ---
const words = [
{ text: "SL√ÑKTING", type: "en" },
{ text: "CYKEL", type: "en" },
{ text: "SLUT", type: "ett" },
{ text: "MOTORCYKEL", type: "en" },
{ text: "MJ√ñLK", type: "en" },
{ text: "HEM", type: "ett" },
{ text: "SEGELB√ÖT", type: "en" },
{ text: "GAFFEL", type: "en" },
{ text: "PROBLEM", type: "ett" },
{ text: "AVDELNING", type: "en" },
{ text: "HAV", type: "ett" },
{ text: "MOROT", type: "en" },
{ text: "MOPED", type: "en" },
{ text: "UPPDRAG", type: "ett" },
{ text: "PROJEKT", type: "ett" },
{ text: "√ñRA", type: "ett" },
{ text: "APELSIN", type: "en" },
{ text: "KAKA", type: "en" },
{ text: "S√ÑRBO", type: "en" },
{ text: "PROGRAM", type: "ett" },
{ text: "SAMTAL", type: "ett" },
{ text: "TALLRIK", type: "en" },
{ text: "√ÖRSTID", type: "en" },
{ text: "√ÑGG", type: "ett" },
{ text: "MAN", type: "en" },
{ text: "RESULTAT", type: "ett" },
{ text: "N√ÑSA", type: "en" },
{ text: "SPEL", type: "ett" },
{ text: "KOMPIS", type: "en" },
{ text: "√ÖRHUNDRADE", type: "ett" },
{ text: "RULLSTOL", type: "en" },
{ text: "CHEF", type: "en" },
{ text: "BEN", type: "ett" },
{ text: "B√ÑRBAR DATOR", type: "en" },
{ text: "FLYGPLAN", type: "ett" },
{ text: "BR√ñD", type: "ett" },
{ text: "SALLAD", type: "en" },
{ text: "LUNCH", type: "en" },
{ text: "PARTNER", type: "en" },
{ text: "LIV", type: "ett" },
{ text: "NAMN", type: "ett" },
{ text: "PRIS", type: "ett" },
{ text: "M√ñTE", type: "ett" },
{ text: "FORDON", type: "ett" },
{ text: "DATOR", type: "en" },
{ text: "KLOCKA", type: "en" },
{ text: "PROMENAD", type: "en" },
{ text: "FAT", type: "ett" },
{ text: "BORD", type: "ett" },
{ text: "BIL", type: "en" },
{ text: "FLICKA", type: "en" },
{ text: "PARKERING", type: "en" },
{ text: "VAPEN", type: "ett" },
{ text: "KASTRULL", type: "en" },
{ text: "ARBETE", type: "ett" },
{ text: "TUNNELBANA", type: "en" },
{ text: "KNIV", type: "en" },
{ text: "BESLUT", type: "ett" },
{ text: "ORD", type: "ett" },
{ text: "K√ñK", type: "ett" },
{ text: "√ñGA", type: "ett" },
{ text: "EFTERMIDDAG", type: "en" },
{ text: "AVTAL", type: "ett" },
{ text: "GLAS", type: "ett" },
{ text: "T√ÖG", type: "ett" },
{ text: "MAMMA", type: "en" },
{ text: "DISKMASKIN", type: "en" },
{ text: "P√ÖST√ÖENDE", type: "ett" },
{ text: "L√ñN", type: "en" },
{ text: "LASTBIL", type: "en" },
{ text: "F√ñRETAG", type: "ett" },
{ text: "SKED", type: "en" },
{ text: "BARN", type: "ett" },
{ text: "DRYCK", type: "en" },
{ text: "AXEL", type: "en" },
{ text: "DAG", type: "en" },
{ text: "STOL", type: "en" },
{ text: "KORV", type: "en" },
{ text: "√ñL", type: "en" },
{ text: "FRU", type: "en" },
{ text: "POJKE", type: "en" },
{ text: "SOPPA", type: "en" },
{ text: "√ÖR", type: "ett" },
{ text: "BUSS", type: "en" },
{ text: "TIMME", type: "en" },
{ text: "BEVIS", type: "ett" },
{ text: "MUN", type: "en" },
{ text: "UGN", type: "en" },
{ text: "DOTTER", type: "en" },
{ text: "F√ñRS√ñK", type: "ett" },
{ text: "HAMBURGARE", type: "en" },
{ text: "RECEPT", type: "ett" },
{ text: "ANSIKTE", type: "ett" },
{ text: "BROR", type: "en" },
{ text: "MINNE", type: "ett" },
{ text: "ARGUMENT", type: "ett" },
{ text: "FOT", type: "en" },
{ text: "SAMARBETE", type: "ett" },
{ text: "M√ÖNAD", type: "en" },
{ text: "ANST√ÑLLNING", type: "en" },
{ text: "F√ñRMIDDAG", type: "en" },
{ text: "KIND", type: "en" },
{ text: "SPIS", type: "en" },
{ text: "K√ñTT", type: "ett" },
{ text: "KOLLEGA", type: "en" },
{ text: "KUND", type: "en" },
{ text: "RYGG", type: "en" },
{ text: "TECKEN", type: "ett" },
{ text: "FLYGPLATS", type: "en" },
{ text: "GRANNE", type: "en" },
{ text: "SYSTEM", type: "ett" },
{ text: "FINGER", type: "ett" },
{ text: "BES√ñK", type: "ett" },
{ text: "GRYTA", type: "en" },
{ text: "SM√ñRG√ÖS", type: "en" },
{ text: "DJUR", type: "ett" },
{ text: "OFFER", type: "ett" },
{ text: "FAKTUM", type: "ett" },
{ text: "PIZZA", type: "en" },
{ text: "ARM", type: "en" },
{ text: "OMR√ÖDE", type: "ett" },
{ text: "SM√ñR", type: "ett" },
{ text: "HAND", type: "en" },
{ text: "HUSVAGN", type: "en" },
{ text: "SAMBO", type: "en" },
{ text: "VIN", type: "ett" },
{ text: "HUVUD", type: "ett" },
{ text: "LAG", type: "ett" },
{ text: "SVAR", type: "ett" },
{ text: "RAKET", type: "en" },
{ text: "MORGON", type: "en" },
{ text: "HELG", type: "en" },
{ text: "JOBB", type: "ett" },
{ text: "V√ÑN", type: "en" },
{ text: "TAXI", type: "en" },
{ text: "PANNA", type: "en" },
{ text: "F√ñRSLAG", type: "ett" },
{ text: "MAGE", type: "en" },
{ text: "TAND", type: "en" },
{ text: "YOGHURT", type: "en" },
{ text: "KROPP", type: "en" },
{ text: "KAFFE", type: "ett" },
{ text: "KAPITEL", type: "ett" },
{ text: "PAPPA", type: "en" },
{ text: "VERKTYG", type: "ett" },
{ text: "BROTT", type: "ett" },
{ text: "SON", type: "en" },
{ text: "HJ√ÑRTA", type: "ett" },
{ text: "NATT", type: "en" },
{ text: "VECKA", type: "en" },
{ text: "UNIVERSITET", type: "ett" },
{ text: "LJUS", type: "ett" },
{ text: "INTRESSE", type: "ett" },
{ text: "VAL", type: "ett" },
{ text: "PAR", type: "ett" },
{ text: "T√Ö", type: "en" },
{ text: "BEHOV", type: "ett" },
{ text: "BREV", type: "ett" },
{ text: "KV√ÑLL", type: "en" },
{ text: "VARDAG", type: "en" },
{ text: "MAT", type: "en" },
{ text: "KRAV", type: "ett" },
{ text: "FEL", type: "ett" },
{ text: "FOTO", type: "ett" },
{ text: "RUM", type: "ett" },
{ text: "TID", type: "en" },
{ text: "SYSTER", type: "en" },
{ text: "SERVETT", type: "en" },
{ text: "OST", type: "en" },

];

const TIMELINE = {

// --- KONTROLLPANEL TIDER OCH VARAKTIGHET ---

// --- KULANS HASTIGHET: hur snabbt spelet rullar fram√•t ---
SPEED: 0.7,

// --- N√ÑR F√ñRSTA SKYLT VISAS: fr√•n det att spelet startas ---
SHOW_WORD: 0.5,

// --- N√ÑR VALPASSAGEN B√ñRJAR SYNAS: fr√•n det att skylten har f√∂rsvunnit ---
SHOW_CHOICES: 2.0,

// --- VARAKTIGHET TILL KOLLISION: fr√•n det att valen b√∂rjade synas ---
COLLISION: 3.5,

// --- VARAKTIGHET TILL NY RUNDA: fr√•n det att valpassagen har passerats ---
PAUSE_AFTER: 1.5

};

// Hj√§lpvariabler f√∂r att veta exakta tidpunkter (Cumulative time)
const TIME_STAMP_WORD = TIMELINE.SHOW_WORD;
const TIME_STAMP_CHOICES = TIME_STAMP_WORD + TIMELINE.SHOW_CHOICES;
const TIME_STAMP_COLLISION = TIME_STAMP_CHOICES + TIMELINE.COLLISION;
const TIME_STAMP_END = TIME_STAMP_COLLISION + TIMELINE.PAUSE_AFTER;

// --- SPELVARIABLER ---
let availableWords = [...words];
let score = 0;         // Meter
let health = 10;       // Startar p√• 10 liv
const MAX_HEALTH = 100;
let stars = 0;
let gameActive = false;
let timer = 0; // Endast en deklaration av timer
let targetX = 0;
let font = null;
let currentWord = null;
let roadSegments = [];
let portalGroup = null;
let wordGroup = null;
let starParticles = [];
let yVelocity = 0;
let isJumping = false;
let isRabbitTrap = false;
let challengeData = { enX: 0, ettX: 0, animalX: 0, processed: false };

// --- GULDMYNT & DISTANS ---
const COINS_PER_JUMP = 10;      // Mynt som kr√§vs f√∂r att hoppa √∂ver muren
const ROUNDS_PER_WALL = 3;      // Antal vanliga rundor innan kaninmur
const COINS_PER_ROUND = 5;      // Antal mynt som spawnas per runda
let coins = 0;                  // Nuvarande mynt-saldo
let distanceTraveled = 0;
let coinMeshes = [];
let lastCoinLane = -99;
let roundsSinceWall = 0;        // Antal vanliga rundor avklarade sedan senaste muren
let rabbitWallPending = false;  // Flagga: n√§sta artikelpassage = kaninmur

const GRAVITY = -0.018, JUMP_FORCE = 0.5;

// (updateStartImage och dekorationsfunktioner f√∂rblir desamma som i din kod...)
const startImages = ['start-1.png', 'start-2.png', 'start-3.png', 'start-4.png', 'start-5.png'];
let remainingImages = [];

function updateStartImage() {
    if (remainingImages.length === 0) remainingImages = [...startImages];
    const randomIndex = Math.floor(Math.random() * remainingImages.length);
    const selectedImage = remainingImages.splice(randomIndex, 1)[0];
    const imgElement = document.getElementById('start-img');
    if (imgElement) imgElement.src = selectedImage;
}
updateStartImage();

function createHouse(x, z) {
    const group = new THREE.Group();
    const wallColors = [0xf5cba7, 0xfdebd0, 0xd5e8d4, 0xdae8fc, 0xf8d7da, 0xfff9c4];
    const roofColors = [0xc0392b, 0x7f8c8d, 0x884ea0, 0x1a5276, 0x6e2f0a];
    const wallColor = wallColors[Math.floor(Math.random() * wallColors.length)];
    const roofColor = roofColors[Math.floor(Math.random() * roofColors.length)];
    const w = 2.5 + Math.random() * 1.5, h = 2 + Math.random() * 1.2, d = 2 + Math.random() * 1.2;
    const walls = new THREE.Mesh(new THREE.BoxGeometry(w, h, d), new THREE.MeshStandardMaterial({ color: wallColor, roughness: 0.8 }));
    walls.position.y = h / 2; group.add(walls);
    const roofGeo = new THREE.CylinderGeometry(0, w * 0.78, h * 0.7, 4);
    const roof = new THREE.Mesh(roofGeo, new THREE.MeshStandardMaterial({ color: roofColor, roughness: 0.7 }));
    roof.position.y = h + h * 0.35 - 0.1; roof.rotation.y = Math.PI / 4; group.add(roof);

    const winMat = new THREE.MeshStandardMaterial({ color: 0xadd8e6, emissive: 0x223344, roughness: 0.1 });

    // Door on the front face (towards road, +x side for right, -x for left ‚Äî handled by rotation below)
    const door = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.9, 0.05), new THREE.MeshStandardMaterial({ color: 0x6d4c41 }));
    door.position.set(0, 0.45, d / 2 + 0.03); group.add(door);

    // Front face windows (beside door)
    [-0.7, 0.7].forEach(ox => {
        const win = new THREE.Mesh(new THREE.BoxGeometry(0.45, 0.45, 0.05), winMat);
        win.position.set(ox, h * 0.6, d / 2 + 0.03); group.add(win);
    });

    // Back face windows
    [-0.7, 0.7].forEach(ox => {
        const win = new THREE.Mesh(new THREE.BoxGeometry(0.45, 0.45, 0.05), winMat);
        win.position.set(ox, h * 0.6, -(d / 2 + 0.03)); group.add(win);
    });

    // Left side windows
    [-0.0].forEach(oz => {
        const win = new THREE.Mesh(new THREE.BoxGeometry(0.05, 0.45, 0.45), winMat);
        win.position.set(-(w / 2 + 0.03), h * 0.6, oz); group.add(win);
    });

    // Right side windows
    [-0.0].forEach(oz => {
        const win = new THREE.Mesh(new THREE.BoxGeometry(0.05, 0.45, 0.45), winMat);
        win.position.set(w / 2 + 0.03, h * 0.6, oz); group.add(win);
    });

    // Rotate house so front door faces the road (towards x=0)
    // Houses on the right (x > 0) rotate -90¬∞, houses on left (x < 0) rotate +90¬∞
    group.rotation.y = x > 0 ? Math.PI / 2 : -Math.PI / 2;

    group.position.set(x, 0, z); return group;
}

function createScenery(z) {
    const group = new THREE.Group();
    const count = 2 + Math.floor(Math.random() * 3);
    for (let i = 0; i < count; i++) {
        const roll = Math.random(), side = Math.random() > 0.5 ? 1 : -1;
        const x = side * (7 + Math.random() * 5), scale = 0.5 + Math.random() * 1.5, zOff = (Math.random() - 0.5) * 5;
        if (roll > 0.65) {
            const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.2, 0.2, 1), new THREE.MeshStandardMaterial({color: 0x5d4037}));
            const foliage = new THREE.Mesh(new THREE.ConeGeometry(1.2, 2.5, 8), new THREE.MeshStandardMaterial({color: 0x2e7d32}));
            foliage.position.y = 1.5; const tree = new THREE.Group(); tree.add(trunk, foliage);
            tree.position.set(x, 0.5, zOff); tree.scale.setScalar(scale); group.add(tree);
        } else if (roll > 0.3) {
            const bush = new THREE.Mesh(new THREE.SphereGeometry(0.7, 8, 8), new THREE.MeshStandardMaterial({color: 0x388e3c}));
            bush.position.set(x, 0.3, zOff); bush.scale.set(scale, scale * 0.7, scale); group.add(bush);
        } else {
            const house = createHouse(x, zOff); house.scale.setScalar(0.7 + Math.random() * 0.6); group.add(house);
        }
    }
    return group;
}

const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playStarSound() {
    const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
    osc.type = 'sine'; osc.frequency.setValueAtTime(800, audioCtx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.1);
    gain.gain.setValueAtTime(0.1, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
    osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.1);
}

const scene = new THREE.Scene();
scene.background = new THREE.Color(0xa2d2ff);
scene.fog = new THREE.Fog(0xa2d2ff, 40, 90);
const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

const texLoader = new THREE.TextureLoader();
const bunnyTexture = texLoader.load('https://learnswedish.github.io/html/bunny.png');

function createTextTexture(text, color) {
    const canvas = document.createElement('canvas');
    canvas.width = 512; canvas.height = 256;
    const ctx = canvas.getContext('2d');
    ctx.fillStyle = 'rgba(255, 255, 255, 0.95)';
    ctx.beginPath(); ctx.roundRect(10, 10, 492, 236, 40); ctx.fill();
    ctx.lineWidth = 15; ctx.strokeStyle = color; ctx.stroke();
    ctx.fillStyle = color; ctx.font = 'bold 140px Work Sans, Arial';
    ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText(text, 256, 128);
    return new THREE.CanvasTexture(canvas);
}

const enTex = createTextTexture("EN", "#1a5d1a");
const ettTex = createTextTexture("ETT", "#8b0000");

scene.add(new THREE.AmbientLight(0xffffff, 1.1));
const sun = new THREE.DirectionalLight(0xffffff, 0.7);
sun.position.set(10, 20, 10); scene.add(sun);

const player = new THREE.Mesh(new THREE.SphereGeometry(0.6, 32, 32), new THREE.MeshStandardMaterial({color: 0xff4444, roughness: 0.3}));
player.position.y = 0.6; scene.add(player);

portalGroup = new THREE.Group(); scene.add(portalGroup);

function triggerStarEffect() {
    playStarSound();
    for(let i=0; i<15; i++) {
        const p = new THREE.Mesh(new THREE.IcosahedronGeometry(0.2, 0), new THREE.MeshStandardMaterial({color: 0xf1c40f, emissive: 0xf1c40f}));
        p.position.set(player.position.x, player.position.y + 0.5, player.position.z);
        p.userData = { vel: new THREE.Vector3((Math.random()-0.5)*0.4, Math.random()*0.4, (Math.random()-0.5)*0.2), life: 1.0 };
        starParticles.push(p); scene.add(p);
    }
}

// --- GULDMYNT ---
function spawnCoinBatch(spawnStartZ) {
    const lanes = [-3, 0, 3];
    const spacing = 22; 
    
    const loader = new THREE.TextureLoader();
    loader.setCrossOrigin('anonymous');
    const coinTexture = loader.load('https://learnswedish.github.io/html/rabbit-coin.png');

    for (let i = 0; i < COINS_PER_ROUND; i++) {
        const available = lanes.filter(l => l !== lastCoinLane);
        const x = available[Math.floor(Math.random() * available.length)];
        lastCoinLane = x;

        const z = spawnStartZ - i * spacing;
        
        // Vi anv√§nder PlaneGeometry f√∂r en platt bild
        const coinGeo = new THREE.PlaneGeometry(1.5, 1.5);
        const coinMat = new THREE.MeshBasicMaterial({ 
            map: coinTexture, 
            transparent: true,
            side: THREE.DoubleSide // G√∂r att bilden syns n√§r den snurrat ett halvt varv
        });
        
        const coinMesh = new THREE.Mesh(coinGeo, coinMat);
        coinMesh.position.set(x, 1.0, z);
        
        scene.add(coinMesh);
        coinMeshes.push(coinMesh);
    }
}

function updateCoins() {
    for (let i = coinMeshes.length - 1; i >= 0; i--) {
        const coin = coinMeshes[i];

        // Detta f√•r myntet att rotera runt st√•ende (vertikalt)
        coin.rotation.y += 0.1; 

        // Resten av din befintliga kod f√∂r borttagning och kollision...
        if (coin.position.z > player.position.z + 2) {
            scene.remove(coin);
            coinMeshes.splice(i, 1);
            continue;
        }

        const dx = coin.position.x - player.position.x;
        const dz = coin.position.z - player.position.z;
        if (Math.abs(dx) < 1.2 && Math.abs(dz) < 1.5) {
            const wasReady = coins >= COINS_PER_JUMP;
            coins = Math.min(coins + 1, COINS_PER_JUMP);
            updateCoinIndicator();
            if (!wasReady && coins >= COINS_PER_JUMP) {
                document.getElementById('jump-available').play();
            } else {
                playStarSound();
            }
            scene.remove(coin);
            coinMeshes.splice(i, 1);
        }
    }
}

function updateCoinIndicator() {
    const pct = Math.min(100, (coins / COINS_PER_JUMP) * 100);
    document.getElementById('coin-bar').style.width = pct + '%';
    if (coins >= COINS_PER_JUMP) {
        document.getElementById('coin-count-label').textContent = '‚úÖ Ready!';
        document.getElementById('coin-bar').style.background = 'linear-gradient(90deg,#2ed573,#00b894)';
    } else {
        document.getElementById('coin-count-label').textContent = `${coins} / ${COINS_PER_JUMP}`;
        document.getElementById('coin-bar').style.background = 'linear-gradient(90deg, #f1c40f, #ff9800)';
    }
}

// --- KANINMUR ---
// L√§gger 6 kaniner (2 rader √ó 3 banor) direkt i den givna groupen
function buildRabbitWall(impactZ) {
    const lanes = [-3, 0, 3];
    const rowOffsets = [0, -3.5];
    lanes.forEach(x => {
        rowOffsets.forEach(dz => {
            const bunny = new THREE.Sprite(new THREE.SpriteMaterial({ map: bunnyTexture, transparent: true }));
            bunny.scale.set(2.3, 2.3, 1);
            bunny.center.set(0.5, 0);
            bunny.position.set(x, 0, impactZ + dz);
            portalGroup.add(bunny);
        });
    });
}

function createGlossyPlate(width, height, color = 0xffffff) {
    const shape = new THREE.Shape();
    const w = width/2, h = height/2, r = 0.4;
    shape.moveTo(-w+r, -h); shape.lineTo(w-r, -h); shape.quadraticCurveTo(w, -h, w, -h+r);
    shape.lineTo(w, h-r); shape.quadraticCurveTo(w, h, w-r, h);
    shape.lineTo(-w+r, h); shape.quadraticCurveTo(-w, h, -w, h-r);
    shape.lineTo(-w, -h+r); shape.quadraticCurveTo(-w, -h, -w+r, -h);
    const geo = new THREE.ExtrudeGeometry(shape, { depth: 0.1, bevelEnabled: true, bevelSize: 0.05, bevelThickness: 0.05 });
    return new THREE.Mesh(geo, new THREE.MeshPhysicalMaterial({ color: color, roughness: 0.1, clearcoat: 1 }));
}

function createRoadSegment(z) {
    const group = new THREE.Group();
    const road = new THREE.Mesh(new THREE.PlaneGeometry(10, 5.1), new THREE.MeshBasicMaterial({color: 0x333333}));
    road.rotation.x = -Math.PI/2; group.add(road);
    const line = new THREE.Mesh(new THREE.PlaneGeometry(0.2, 2), new THREE.MeshBasicMaterial({color: 0xffffff}));
    line.rotation.x = -Math.PI/2; line.position.y = 0.01; group.add(line);
    const grass = new THREE.Mesh(new THREE.PlaneGeometry(60, 5.1), new THREE.MeshStandardMaterial({color: 0x7cb342}));
    grass.rotation.x = -Math.PI/2; grass.position.y = -0.05; group.add(grass);
    group.add(createScenery(z)); group.position.z = z; scene.add(group); return group;
}

for(let i=0; i<100; i++) roadSegments.push(createRoadSegment(-i * 5));

const loader = new FontLoader();
loader.load('https://cdn.jsdelivr.net/npm/three@0.158.0/examples/fonts/droid/droid_sans_bold.typeface.json', f => {
    font = f;
    const hs = localStorage.getItem('grammarHigh') || 0;
    document.getElementById('high-score-display').textContent = `RECORD: ${hs}`;
});

function initRound() {
    if (availableWords.length === 0) { endGame(true); return; }

    timer = 0;
    challengeData.processed = false;
    isRabbitTrap = false;

    // Rensa gamla objekt
    portalGroup.clear();
    if (wordGroup) { scene.remove(wordGroup); wordGroup = null; }

    // R√§kna upp rundor. Efter ROUNDS_PER_WALL vanliga rundor ‚Üí kaninmur
    roundsSinceWall++;
    if (roundsSinceWall > ROUNDS_PER_WALL) {
        // Dags f√∂r kaninmur ‚Äì s√§tt flagga, v√§lj ord MEN ta INTE bort det fr√•n listan
        rabbitWallPending = true;
        roundsSinceWall = 0;
    } else {
        rabbitWallPending = false;
    }

    // V√§lj ord (alltid ‚Äì √§ven vid kaninmurrunda visar vi substantivet)
    const idx = Math.floor(Math.random() * availableWords.length);
    currentWord = availableWords[idx];
    // Ta bara bort ordet om det INTE √§r en kaninmurrunda
    if (!rabbitWallPending) {
        availableWords.splice(idx, 1);
    }

    // Slumpa banplacering (anv√§nds vid vanliga rundor, ignoreras vid kaninmur)
    let lanes = [-3, 0, 3].sort(() => Math.random() - 0.5);
    challengeData.enX = lanes[0];
    challengeData.ettX = lanes[1];
    challengeData.animalX = lanes[2];
}

function endGame(victory) {
    gameActive = false; 
    document.getElementById('bg-music').pause();
    
    // Avrunda po√§ngen till heltal innan de sparas och visas
    const finalScore = Math.floor(score); 
    const high = parseInt(localStorage.getItem('grammarHigh')) || 0;
    
    if (finalScore > high) {
        localStorage.setItem('grammarHigh', finalScore);
    }
    
    const currentHigh = localStorage.getItem('grammarHigh') || 0;
    
    document.getElementById('modal-title').textContent = victory ? "SESSION COMPLETE" : "GAME OVER";
    
    // Uppdaterad display: Inga decimaler, inga mynt, r√§tt etikett f√∂r rekord
    document.getElementById('final-stats').innerHTML = `
        Score: ${finalScore} m<br>
        Personal best: ${currentHigh} m
    `;
    
    document.getElementById('victory-modal').style.display = 'block';
}

window.addEventListener('keydown', e => {
    if(!gameActive) return;
    if(e.key === "ArrowLeft") targetX = Math.max(-3, targetX - 3);
    if(e.key === "ArrowRight") targetX = Math.min(3, targetX + 3);
    if(e.code === "Space" && !isJumping && coins >= COINS_PER_JUMP) {
        coins = 0; stars = 0; yVelocity = JUMP_FORCE; isJumping = true;
        document.getElementById('jump-sound').play();
        
        updateCoinIndicator();
    }
});

// ‚îÄ‚îÄ TOUCH / SWIPE CONTROLS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let touchStartX = 0, touchStartY = 0;
const SWIPE_THRESHOLD = 40; // px minimum to count as a swipe

document.addEventListener('touchstart', e => {
    touchStartX = e.touches[0].clientX;
    touchStartY = e.touches[0].clientY;
}, { passive: true });

document.addEventListener('touchend', e => {
    if (!gameActive) return;
    const dx = e.changedTouches[0].clientX - touchStartX;
    const dy = e.changedTouches[0].clientY - touchStartY;

    if (Math.abs(dx) > Math.abs(dy)) {
        // Horizontal swipe ‚Äì lane change
        if (Math.abs(dx) >= SWIPE_THRESHOLD) {
            if (dx > 0) targetX = Math.min(3, targetX + 3);   // swipe right
            else        targetX = Math.max(-3, targetX - 3);  // swipe left
        }
    } else {
        // Vertical swipe upward ‚Äì jump
        if (dy < -SWIPE_THRESHOLD && !isJumping && coins >= COINS_PER_JUMP) {
            coins = 0; stars = 0; yVelocity = JUMP_FORCE; isJumping = true;
            document.getElementById('jump-sound').play();
            updateCoinIndicator();
        }
    }
}, { passive: true });

function animate() {
    requestAnimationFrame(animate);
    if (!gameActive) return;

    // 1. TIDSHANTERING
    timer += 1 / 60;

    // 2. SPELARR√ñRELSE
    player.position.z -= TIMELINE.SPEED;
    player.position.x += (targetX - player.position.x) * 0.2;
    
    player.position.y += yVelocity;
    yVelocity += GRAVITY;
    if (player.position.y <= 0.6) { 
        player.position.y = 0.6; 
        yVelocity = 0; 
        isJumping = false; 
    }
    player.rotation.x -= TIMELINE.SPEED * 1.5;

    // 3. UI-UPPDATERING (METER & H√ÑLSA)
    // R√§kna "riktiga" meter baserat p√• framfart
    distanceTraveled += TIMELINE.SPEED * 0.5; 
    score = Math.floor(distanceTraveled);
    document.getElementById('score-val').textContent = score + ' m';
    
    // Uppdatera Livsindikatorn (H√§lsa)
    const healthBar = document.getElementById('health-bar');
    const healthVal = document.getElementById('health-val');
    if (healthBar && healthVal) {
        const healthPct = Math.max(0, (health / 100) * 100);
        healthBar.style.width = healthPct + '%';
        healthVal.textContent = `${Math.ceil(health)} / 100`;
        
        // Byt f√§rg p√• h√§lsa om den √§r l√•g
        healthBar.style.background = health < 30 ? '#ff4444' : '#f44336';
    }

    // D√ñDS-CHECK: Om h√§lsan n√•r noll
    if (health <= 0) {
        health = 0;
        endGame(false);
        return;
    }

    
    camera.position.set(0, 5, player.position.z + 9);
    camera.lookAt(0, 1.2, player.position.z - 5);

    updateCoins();

    // 4. PARTIKELSYSTEM
    for (let i = starParticles.length - 1; i >= 0; i--) {
        const p = starParticles[i];
        p.position.add(p.userData.vel);
        p.userData.life -= 0.02;
        p.scale.setScalar(p.userData.life);
        if (p.userData.life <= 0) {
            scene.remove(p);
            starParticles.splice(i, 1);
        }
    }

    // --- TIMELINE LOGIK ---

    // FAS A: VISA ORDET
    if (timer >= TIME_STAMP_WORD && !wordGroup && font) {
        wordGroup = new THREE.Group();
        const geo = new TextGeometry(currentWord.text, { font: font, size: 0.72, height: 0.12, curveSegments: 14 });
        geo.center();
        
        const plateW = Math.max(5.2, (geo.boundingBox ? geo.boundingBox.max.x - geo.boundingBox.min.x : 5) + 2.2);
        const signColor = 0x1a5276;
        
        const border = createGlossyPlate(plateW + 0.22, 1.9 + 0.22, 0xdddddd);
        border.position.z = -0.02;
        const plate = createGlossyPlate(plateW, 1.9, signColor);
        const txt = new THREE.Mesh(geo, new THREE.MeshStandardMaterial({ color: 0xffffff, emissive: 0xffffff, emissiveIntensity: 0.15 }));
        txt.position.z = 0.18;
        
        wordGroup.add(border, plate, txt);
        wordGroup.position.set(0, 10, player.position.z - 12);
        scene.add(wordGroup);
    }

    if (wordGroup) {
        if (timer < TIME_STAMP_CHOICES) {
            wordGroup.position.z = player.position.z - 12;
            wordGroup.position.y += (3.5 - wordGroup.position.y) * 0.1;
            wordGroup.lookAt(camera.position);
        } else {
            wordGroup.position.y += (1.2 - wordGroup.position.y) * 0.1;
        }
    }

    // FAS B: VISA VALEN
    if (timer >= TIME_STAMP_CHOICES && portalGroup.children.length === 0) {
        const distRemaining = TIMELINE.COLLISION * TIMELINE.SPEED * 60;
        const impactZ = player.position.z - distRemaining;

        if (rabbitWallPending) {
            buildRabbitWall(impactZ);
        } else {
            const createSign = (tex, x) => {
                const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: tex, transparent: true }));
                sprite.scale.set(3, 1.75, 1); sprite.position.set(x, 1.2, impactZ);
                portalGroup.add(sprite);
            };
            createSign(enTex, challengeData.enX);
            createSign(ettTex, challengeData.ettX);
            const animal = new THREE.Sprite(new THREE.SpriteMaterial({ map: bunnyTexture, transparent: true }));
            animal.scale.set(2.3, 2.3, 1); animal.center.set(0.5, 0); animal.position.set(challengeData.animalX, 0, impactZ);
            portalGroup.add(animal);
        }
    }

    // FAS C: KOLLISION
    if (timer >= TIME_STAMP_COLLISION && !challengeData.processed) {
        challengeData.processed = true;

        if (rabbitWallPending) {
            if (player.position.y < 1.8) {
                document.getElementById('rabbit-hurt').play();
                scene.background = new THREE.Color(0xff4444);
                setTimeout(() => { if(gameActive) scene.background = new THREE.Color(0xa2d2ff); }, 200);
                endGame(false);
                return;
            } else {
                coins = 0; roundsSinceWall = 0; rabbitWallPending = false;
                
                updateCoinIndicator();
            }
        } else {
            const playerLane = Math.round(player.position.x / 3) * 3;
            if (player.position.y < 1.8) {
                if (playerLane === challengeData.animalX) {
                    document.getElementById('rabbit-hurt').play();
                    scene.background = new THREE.Color(0xff4444);
                    setTimeout(() => { if(gameActive) scene.background = new THREE.Color(0xa2d2ff); }, 200);
                    endGame(false);
                    return;
                } else {
                    const chosenType = (playerLane === challengeData.enX) ? "en" : "ett";
                    if (chosenType === currentWord.type) {
                        triggerStarEffect();
                        health = Math.min(100, health + 10); // BONUS: +10 Liv
                    } else {
                        document.getElementById('error-sound').play();
                        health -= 20; // STRAFF: -20 Liv
                        scene.background = new THREE.Color(0xff4444);
                        setTimeout(() => { if(gameActive) scene.background = new THREE.Color(0xa2d2ff); }, 150);
                    }
                }
            }
            spawnCoinBatch(player.position.z - 35);
        }
    }

    // FAS D: NY RUNDA
    if (timer >= TIME_STAMP_END) {
        initRound();
    }

    // 5. ROAD RECYCLING
    roadSegments.forEach(s => { 
        if (s.position.z > player.position.z + 15) {
            s.position.z -= 500;
            const sceneryGroup = s.children[s.children.length - 1];
            sceneryGroup.children.forEach(obj => { obj.position.z = (Math.random() - 0.5) * 5; });
        }
    });

    renderer.render(scene, camera);
}

window.addEventListener('keydown', (e) => { if (e.key === "Enter" && !gameActive) document.getElementById('overlay').click(); });

document.getElementById('overlay').addEventListener('click', () => {
    // 1. Ljud och bakgrund
    audioCtx.resume();
    scene.background = new THREE.Color(0xa2d2ff);
    document.getElementById('bg-music').volume = 0.3;
    document.getElementById('bg-music').play().catch(e => {});

    // 2. Rekord och UI
    const hs = localStorage.getItem('grammarHigh') || 0;
    document.getElementById('high-score-display').textContent = `RECORD: ${hs} m`;
    updateCoinIndicator();

    // 3. Nollst√§ll alla spelvariabler (inga dubbletter h√§r nu)
    availableWords = [...words];
    score = 0;
    distanceTraveled = 0;
    health = 10;            // Startar p√• 10 liv enligt dina nya regler
    coins = 0;
    stars = 0;
    timer = 0;
    targetX = 0;
    yVelocity = 0;
    isJumping = false;
    roundsSinceWall = 0;
    rabbitWallPending = false;
    lastCoinLane = -99;

    // 4. Rensa gamla objekt fr√•n scenen
    coinMeshes.forEach(c => scene.remove(c));
    coinMeshes = [];
    if (wordGroup) { scene.remove(wordGroup); wordGroup = null; }
    portalGroup.clear();

    // 5. √Öterst√§ll positioner
    player.position.set(0, 0.6, 0);
    roadSegments.forEach((s, i) => s.position.z = -i * 5);

    // 6. Starta spelet
    document.getElementById('overlay').style.display = 'none';
    document.getElementById('victory-modal').style.display = 'none';
    gameActive = true;
    initRound();
});
window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
});

animate();
</script>
</body>
</html>
